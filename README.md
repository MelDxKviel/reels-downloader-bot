# reels-downloader-bot

Telegram-бот для скачивания видео по ссылке (YouTube / Instagram Reels / TikTok / X(Twitter)).  
Проект построен на `aiogram` и использует `yt-dlp` для загрузки. Доступ к боту ограничивается списком пользователей, которым управляет администратор через команды в Telegram. Статистика использования собирается в PostgreSQL.

## Возможности

- **Скачивание видео по ссылке**: отправьте боту ссылку — бот скачает и пришлёт файл (с учётом лимита Telegram).
- **Кэш скачиваний**: повторные ссылки могут отдаваться из локального кэша.
- **Ограничение доступа**:
  - **Администраторы** задаются через `ADMIN_USERS` (в `.env`).
  - **Разрешённые пользователи** хранятся в базе данных и управляются админ-командами.
- **Статистика**:
  - Общая статистика по боту
  - Статистика по конкретному пользователю
  - Разбивка по платформам (YouTube/Instagram/TikTok/X)
- **Docker Compose**: запуск бота + PostgreSQL одной командой.

## Конфигурация

Перед запуском создайте файл окружения (можно на основе `env.example`) и заполните переменные:

- **BOT_TOKEN**: токен бота из BotFather
- **ADMIN_USERS**: список Telegram user_id администраторов через запятую
- **DATABASE_URL**: строка подключения к PostgreSQL (async SQLAlchemy)
- **POSTGRES_PASSWORD**: пароль PostgreSQL (используется в Docker Compose)
- **DOWNLOAD_DIR**: директория для загруженных файлов (по умолчанию `downloads`)
- **YT_COOKIES_FILE**: путь к файлу cookies для YouTube (для видео 18+)
- **YT_COOKIES_FILE_HOST_PATH**: (только для Docker Compose) путь к cookies-файлу на хосте, который будет смонтирован в контейнер как `/app/cookies.txt`

Важно:
- Если `ADMIN_USERS` пустой — админ-команды будут недоступны.
- Обычные пользователи должны быть добавлены администратором, иначе доступ к боту будет запрещён.

## Запуск (локально, через uv)

1) Установите `uv` (см. документацию Astral).  
2) Установите зависимости: `uv sync`  
3) Заполните `.env`  
4) Запустите бота: `uv run python -m src.main`

Примечание: для некоторых форматов может понадобиться FFmpeg. Если его нет, часть видео может не скачиваться (особенно когда требуется склейка аудио+видео).

## Запуск (Docker Compose)

1) Заполните `.env` (можно на основе `env.example`; как минимум `BOT_TOKEN`, `ADMIN_USERS`, при необходимости `POSTGRES_PASSWORD`).  
2) Запустите сервисы: `docker compose up -d`  
3) Логи бота: `docker compose logs -f bot`

Данные PostgreSQL сохраняются в volume `postgres_data`. Скачанные файлы сохраняются в локальную папку `downloads/` (смонтирована в контейнер).

## Админ-команды

Доступны только пользователям из `ADMIN_USERS`:

- **/adminhelp** — справка по админ-командам
- **/adduser USER_ID** — добавить пользователя (разрешить доступ)
- **/removeuser USER_ID** — удалить пользователя (запретить доступ)
- **/users** — список разрешённых пользователей
- **/stats** — общая статистика бота
- **/userstats USER_ID** — статистика по конкретному пользователю

## Пользовательские команды

- **/start** — приветствие и краткая инструкция
- **/help** — справка
- **/id** — показать ваш Telegram user_id
- **/cache** — информация о локальном кэше скачанных файлов
- **/clearcache** — очистка локального кэша

## Видео с ограничениями 18+ (YouTube)

Для скачивания видео с возрастными ограничениями необходимо предоставить cookies вашего YouTube-аккаунта:

1. Установите расширение для браузера (например, «Get cookies.txt LOCALLY» для Chrome).
2. Войдите в свой YouTube-аккаунт.
3. Откройте любую страницу YouTube и экспортируйте cookies в файл `cookies.txt`.
4. Укажите путь в переменных окружения:
   - Для Docker Compose:
     - `YT_COOKIES_FILE=/app/cookies.txt`
     - `YT_COOKIES_FILE_HOST_PATH=ПУТЬ_НА_ХОСТЕ_ДО_cookies.txt` (по умолчанию `./cookies.txt`)
   - Для локального запуска:
     - `YT_COOKIES_FILE=ПУТЬ_НА_ХОСТЕ_ДО_cookies.txt`

Примеры:
- Docker Compose (Windows): `YT_COOKIES_FILE_HOST_PATH=C:\Users\me\Downloads\cookies.txt`
- Локально (Windows): `YT_COOKIES_FILE=C:\Users\me\Downloads\cookies.txt`

Cookies могут истекать со временем — при ошибках авторизации повторите экспорт.
